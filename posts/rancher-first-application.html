<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Khurram Aziz - Rancher&#x2013;First Application</title>

  <link rel="canonical" href='/posts/rancher-first-application'>

      <link type="application/rss+xml" rel="alternate" title="Khurram Aziz" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" title="Khurram Aziz" href="/feed.atom" />

  <meta name="application-name" content='Khurram Aziz' />
  <meta name="msapplication-tooltip" content='Khurram Aziz' />
  <meta name="msapplication-starturl" content='/' />

  <meta property="og:title" content='Khurram Aziz - Rancher&#x2013;First Application' />
  <meta property="og:type" content="website" />
  <meta property="og:url" content='/posts/rancher-first-application' />

  <link rel="icon" href='/favicon.ico'>

  <!-- Custom fonts for this template -->
  <link href='/vendor/fontawesome-free/css/all.min.css' rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" data-no-mirror>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" data-no-mirror>

  <!-- Styles for this template (also includes Bootstrap) -->
  <link href='/scss/clean-blog.css' rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" data-no-mirror></script>
  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet">

  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href='/'>Khurram Aziz</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ms-auto">
          <li class="nav-item">
    <a class="nav-link" href="/pages/about">About</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/pages/series">Series</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/posts">Posts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/tags">Tags</a>
  </li>

      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->
  <header class="masthead no-image">
  <div class="container position-relative">
    <div class="row">
      <div class="col-md-12">
        <div class='post-heading'>
          <h1>
            Rancher&#x2013;First Application
          </h1>
            <div class="meta">Published on Monday, August 1, 2016</div>
              <div class="mt-3">
                  <a href="/tags/docker" class="badge text-bg-light"> Docker</a>
                  <a href="/tags/node" class="badge text-bg-light"> Node</a>
                  <a href="/tags/system-administration" class="badge text-bg-light"> System Administration</a>
              </div>
        </div>
      </div>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div id="content" class="col-md-12">
        <h2>Rancher Series</h2>  <ul>   <li>Part 1: <a title="RancherOS" href="rancheros.html">RancherOS</a> </li>    <li>Part 2: <a title="Rancher–First Application" href="rancher-first-application.html">Rancher–First Application</a> </li>    <li>Part 3: <a title="Rancher Infrastructure Services" href="rancher-infrastructure-services.html">Rancher Infrastructure Services</a> </li>    <li>Part 4: <a title="Floating IP and Containers" href="floating-ip-and-containers.html">Floating IP and Containers</a> </li> </ul>  <p><a href="/images/Rancher-First-Application_BBFC/image.png"><img title="create-mongodb-stack" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:right;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="New MongoDB Stack" src="/images/Rancher-First-Application_BBFC/image_thumb.png" width="240" align="right" height="169" /></a><a href="/images/Rancher-First-Application_BBFC/image_3.png"><img title="catalog" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:right;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="Rancher Catalog" src="/images/Rancher-First-Application_BBFC/image_thumb_3.png" width="240" align="right" height="108" /></a>Lets deploy the first application on <a href="rancheros.html" target="_blank">our Rancher Environment</a> that we created in the first post. We will be deploying <a href="https://github.com/sdelements/lets-chat" target="_blank">let’s Chat</a> application; its an open source Slack clone built using NodeJS and MongoDB. There exists an official <a href="https://hub.docker.com/r/sdelements/lets-chat/" target="_blank">let’s Chat Docker Container</a> so we have a quick clean start.</p>  <p>As we <a href="rancheros.html" target="_blank">setup two hosts for our Rancher Environment earlier</a>; we will try to deploy it in High Availability and Scalable configuration. Rancher has a catalog and from there we can deploy the MongoDB Stack. This particular Stack setups three clustered MongoDB containers with the specified replication set name. I went ahead and set it up with default values. There are few “sidekick” containers. Its Rancher specific and these are the containers “bound” to the primary container and these all always deployed + run as a unit; we can use this feature to setup volumes or run setup scripts for the primary container. There are two sidekicks for each Mongo Container in the catalog item.</p>  <p>On Launch; it will setup the required containers across our two hosts shortly; it downloads the Docker Images from the Docker Hub; for large containers setup may take a while depending on the network speed. It feel bizarre that Rancher has no built in option that image downloads are orchestrated as well and network resource is not wasted in multiple downloads of same image per host.</p>  <p><a href="/images/Rancher-First-Application_BBFC/image_4.png"><img title="infrastructure" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:right;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="Infrastructure" src="/images/Rancher-First-Application_BBFC/image_thumb_4.png" width="240" align="right" height="199" /></a><a href="/images/Rancher-First-Application_BBFC/image_5.png"><img title="mongodb-stack" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:right;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="MongoDB Stack" src="/images/Rancher-First-Application_BBFC/image_thumb_5.png" width="240" align="right" height="95" /></a>Once setup; we can scale up or down the MongoDB stack; I set it to two so I have one MongoDB container per host. We can view CPU/Memory and Network usage of the container and review the Sidekick containers from the interface. Knowing the docker image name of the sidekick we can review it on the Docker Hub and if we are lucky can find its source from there or by googling! This is a fantastic way to learn how the community has built up these Stacks; I encourage to go ahead and try other stacks as well!</p>  <p>Rancher provides a modern User Interface to manage and orchestrate our Docker Containers; we can view our Hosts and the containers running on them; we can stop / start or restart the containers easily using the interface.</p>  <p>Given we scaled down the MongoDB stack; there is “an instance” of one stopped image; we can go ahead and Purge it</p>  <p><a href="/images/Rancher-First-Application_BBFC/image_13.png"><img title="lets-chat" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:left;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="let&#39;s Chat" src="/images/Rancher-First-Application_BBFC/image_6.png" width="240" align="left" height="126" /></a></p>  <p>Now our MongoDB is running in the replication mode across two hosts; even if container goes down or one of the machine running these containers goes down; the MongoDB service will remain available.</p>  <p>Next we need to deploy let’s Chat Docker container in a similar way; notice I have specified to run one instance on each host so it gets deployed on all participating host; have specified their official Docker Image and has linked up our MongoDB cluster as “mongo” service; their image requirement.</p>  <p>We need to do one more step; if we run the letsChat container as is; it will give error failing to connect to our MongoDB cluster; luckily let’s Chat official container has <a href="https://github.com/sdelements/lets-chat/wiki/Environment-variables" target="_blank">option to set environment variables</a>; and one of it is the Mongo connection string. For the cluster we need to specify the IP addresses of all the MongoDB nodes that we can learn about from Infrastructure page</p>  <p><a href="/images/Rancher-First-Application_BBFC/image_14.png"><img title="image" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:right;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="image" src="/images/Rancher-First-Application_BBFC/image_7.png" width="240" align="right" height="114" /></a>Lets set LCB_DATABASE_URI environment variable for the letsChat container and give ips of all the MongoDB nodes in the connection string as per <a href="http://mongoosejs.com/docs/connections.html" target="_blank">Mongoose requirement</a>; in my case the connection string is <b>mongodb://10.42.38.6:27017,10.42.59.150:27017/letschat</b></p>  <p>Lets go ahead and deploy the container; it will download the image from Docker Hub and run an instance on all participating hosts shortly.</p>  <p>Rancher interface also has option to connect to the container’s shell or view their logs; using these; the system administrators or developers can debug and solve any issue.</p>  <p><a href="/images/Rancher-First-Application_BBFC/image_15.png"><img title="execute-shell" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:left;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="Execute Shell" src="/images/Rancher-First-Application_BBFC/image_8.png" width="640" align="left" height="269" /></a>We can connect to the shell and confirm that Rancher has made appropriate hosts entries for the Mongo Cluster.</p>  <p>If the web application is failing to connect to the MongoDB or giving errors; we can review them from View Logs and from the shell debug and fix it. For instance if we dont set the environment variable above for clustered mongodb; it will fail to run and view logs will have the Mongoose error!</p>  <ul>   <li>Note that Rancher and other similar products have similar features; being developers we should use standard output and error streams and emit appropriate logs that the system administrators can use. They will also appreciate if we provide utilities in the containers to troubleshoot or fix the issue on their own! </li> </ul>  <p>So now we have two instances of the web server containers and a clustered MongoDB; for the fail-over and scalability we need a “Load Balancer”. Rencher has built-in one and lets deploy an instance of it!</p>  <p><img title="add-load-balancer" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="Add Load Balancer" src="/images/Rancher-First-Application_BBFC/image_9.png" width="640" height="109" /></p>  <p><a href="/images/Rancher-First-Application_BBFC/image_16.png"><img title="load-balancer-config" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;float:right;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="Load Balancer Configuration" src="/images/Rancher-First-Application_BBFC/image_10.png" width="240" align="right" height="135" /></a>Lets use the same always run one instance scalability option for the Load Balancer; map service-container’s 8080 port (letsChat official container is running the app at 8080 port) and link up the service. Rancher’s Load Balancer is haProxy based and instead of making our onw, using their offering; we can link our web service and it will find (if we have just one container running) and load balance across multiple running containers of our web app seamlessly.</p>  <p>If we want to; we can further customize the haproxy configuration file; the user interface allows us to add configurations. For our case; nothing else required.</p>  <p>Now our stack is complete and we can access the application at the two IPs of our participating hosts!</p>  <p><img title="letschat-stack" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="let&#39;s Chat" src="/images/Rancher-First-Application_BBFC/image_11.png" width="1241" height="574" /></p>  <p>You might notice the IPs of the containers are changed; its because I went ahead and “Cloned” the containers (that Rancher supports; the quickest way to copy existing containers) setting environment variable accordingly; and while making new containers I choose not to restart the containers; the default configuration; so that I can stop few and simulate container failure. I am stopping one web server container; but I am still able to access my application</p>  <p><img title="failing-web-server" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" border="0" alt="Failing Web Server" src="/images/Rancher-First-Application_BBFC/image_12.png" width="1240" height="555" /></p>  <p>So we have a fairly complete fail-over and scale out implementation here, if MongoDB container or NodeJS container goes down things will continue to work, even if traffic is coming on one IP; load is distributed across all participating nodes. The only questions left are what if one of the Load Balancer goes down? And which IP to give in the DNS for our application? 192.168.10.15 (Rancher2 VM) or 192.168.10.16 (Rancher3 VM)? If we give both IPs; the traffic will load balance across these two machines; but what if whole host is brought down for maintenance? We will figure it out in the next post!</p>


        

      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="copyright">Copyright &#xA9; 2024</p>

        <ul class="list-inline text-center small">
            <li class="list-inline-item">
              <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
            </li>
            <li class="list-inline-item">
              <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
            </li>
        </ul>
        <br />
        <div class="font-weight-bold small"><a href="https://statiq.dev">Generated by Statiq</a></div>
      </div>
    </div>
  </div>
</footer>


  <!-- Scripts -->
  <script src='/vendor/bootstrap/js/bootstrap.bundle.min.js'></script>
  <script src='/vendor/startbootstrap-clean-blog/js/scripts.js'></script>
  <script src='/js/clean-blog.js'></script>
  

  

</body>

</html>
