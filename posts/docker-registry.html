<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Khurram Aziz - Docker Registry</title>

  <link rel="canonical" href='/posts/docker-registry'>

      <link type="application/rss+xml" rel="alternate" title="Khurram Aziz" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" title="Khurram Aziz" href="/feed.atom" />

  <meta name="application-name" content='Khurram Aziz' />
  <meta name="msapplication-tooltip" content='Khurram Aziz' />
  <meta name="msapplication-starturl" content='/' />

  <meta property="og:title" content='Khurram Aziz - Docker Registry' />
  <meta property="og:type" content="website" />
  <meta property="og:url" content='/posts/docker-registry' />

  <link rel="icon" href='/favicon.ico'>

  <!-- Custom fonts for this template -->
  <link href='/vendor/fontawesome-free/css/all.min.css' rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" data-no-mirror>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" data-no-mirror>

  <!-- Styles for this template (also includes Bootstrap) -->
  <link href='/scss/clean-blog.css' rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" data-no-mirror></script>
  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet">

  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href='/'>Khurram Aziz</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ms-auto">
          <li class="nav-item">
    <a class="nav-link" href="/pages/about">About</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/pages/series">Series</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/posts">Posts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/tags">Tags</a>
  </li>

      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->
  <header class="masthead no-image">
  <div class="container position-relative">
    <div class="row">
      <div class="col-md-12">
        <div class='post-heading'>
          <h1>
            Docker Registry
          </h1>
            <div class="meta">Published on Tuesday, March 21, 2017</div>
              <div class="mt-3">
                  <a href="/tags/net" class="badge text-bg-light"> .NET</a>
                  <a href="/tags/devops" class="badge text-bg-light"> DevOps</a>
                  <a href="/tags/docker" class="badge text-bg-light"> Docker</a>
              </div>
        </div>
      </div>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div id="content" class="col-md-12">
          <table cellspacing="0" cellpadding="0">      <tr>          <td style="width:300px;vertical-align:top;">              <p><b>Docker Swarm Series</b></p>                <ul>                  <li><a target="_blank" href="docker-swarm.html">Docker Swarm</a></li>                    <li>This Post</li>                    <li><a target="_blank" href="jenkins.html">Jenkins</a></li>    <li><a target="_blank" href="swarm-and-prometheus.html">Swarm and Prometheus</a></li>  <li><a target="_blank" href="swarm-and-prometheus-ii.html">Swarm and Prometheus II</a></li>              </ul>          </td>            <td style="width:300px;vertical-align:top;">              <p><b>Dotnet Core Series</b></p>                <ul>                  <li><a target="_blank" href="dotnet-core.html">Dotnet Core</a></li>                    <li><a target="_blank" href="redis-clients-asp-net-core.html">Redis Clients -- ASP.NET Core</a></li>                    <li>This Post</li>                    <li><a target="_blank" href="jenkins.html">Jenkins</a></li>                    <li><a target="_blank" href="dotnetcore-postgresql.html">Dotnet Core -- PostgreSQL</a></li>              </ul>          </td>      </tr>  </table>    <p>In the “Redis Clients :: ASP.NET Core” post; we made a minimalist ASP.NET Core MVC application that uses Redis; we made v2 Docker Compose file that we used to deploy our application on the Docker as two Containers; one running Redis Server and the other running the ASP.NET Core application. Even though we used Redis and Distributed Caching; but our application still was deployed on the single host. Given its based on a micro-service Docker friendly architecture, we can write a v3 Compose file and using <a target="_blank" href="https://docs.docker.com/engine/reference/commandline/stack_deploy">Stack Deploy</a> command we can deploy it on a multi-host Docker Swarm setup. Here’s one such v3 compose file</p>   <script src="https://gist.github.com/khurram-aziz/f4bba3db343ddffdb96db93f0d07dd4c.js"></script>    <ul>     <li>If you are following the Dotnet Core Series; you might have noticed that build and restart options&nbsp;are gone from the v2 compose file that we made in the previous post. This is because if deploying to Docker Swarm; those two are not supported </li>   </ul>      <p>Before doing stack deploy; given we need a “custom” image; we need to ensure that this image exists with the Docker Daemon and for this we obviously need to first publish our Dotnet Core app; and then we can build the Docker image from the Dockerfile against the Docker Daemon.</p>      <p><img title="registry-docker-build" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-docker-build" src="/images/ee4bc29833cd_ABDC/registry-docker-build.png" border="0" height="662" width="1307"></p>      <ul>     <li>I have used docker-compose to build the image above; I am having the Docker Client and Docker Machine in Linux Subsystem configured against the Swarm and given the Linux Subsystem is still “beta” due to <a title="https://github.com/Microsoft/BashOnWindows/issues/1123" href="https://github.com/Microsoft/BashOnWindows/issues/1123">https://github.com/Microsoft/BashOnWindows/issues/1123</a> we cannot build the image against a remote Docker Daemon (Swarm Node in this case); however docker-compose works fine; and we can use it to build the image from Linux Subsystem&nbsp;</li>   </ul>      <p>Once our custom image is made; we can do Stack Deploy using the v3 Compose file we made earlier</p>   <script src="https://gist.github.com/khurram-aziz/eb9a52e002dad3c91fa59967d74d6064.js"></script>    <p>The mvcapp container needs to be globally deployed but it gets deployed only on the one node against on where we build it:</p>      <p><img title="registry-stack-deploy" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-stack-deploy" src="/images/ee4bc29833cd_ABDC/registry-stack-deploy.png" border="0" height="875" width="1031"></p>      <p>We need to make that mvcapp image available to the remaining participating nodes as well; we can either build the image on each Docker Daemon in the Swarm or we can setup a “Docker Registry” where we can make our image available and setup Swarm nodes with this Registry; update the v3 compose file and redeploy the stack and all the swarm nodes will get the image from the “Registry”. There exists an open source Docker Registry as an official Docker Container image; and running it just a docker run away</p>   <script src="https://gist.github.com/khurram-aziz/405af0de78af329e401e8c1bf8502c18.js"></script>    <p><img title="registry-docker-run" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-docker-run" src="/images/ee4bc29833cd_ABDC/registry-docker-run.png" border="0" height="350" width="772"></p>      <p>There is an excellent TL;DR; at <a target="_blank" href="https://docs.docker.com/registry">https://docs.docker.com/registry</a>; you basically tag the existing custom image prefixing the registry url; in our case we will tag mvcapp as 192.168.10.14:5000/mvcapp; and then push it; and Docker Daemon will upload the image to the Registry; similar to Docker Hub! But it would not work</p>      <p><img title="registry-https-error" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-https-error" src="/images/ee4bc29833cd_ABDC/registry-https-error.png" border="0" height="372" width="819"></p>      <p>The problem now is; this Docker Registry is not “secured” and Docker Daemon by default only likes secured remote registries; we now need to add our registry as "trusted" unsecured remote registry in the docker daemon configuration. It depends what setup you are using; for instance I am using RancherOS to run the Docker Engines; and to add the remote registries; I have to do this:</p>   <script src="https://gist.github.com/khurram-aziz/657a53f73ff32b03438246e96326c762.js"></script>    <ul>     <li><a title="https://docs.rancher.com/os/configuration/docker" target="_blank" href="https://docs.rancher.com/os/configuration/docker">https://docs.rancher.com/os/configuration/docker</a> for more information on configuring Docker on RancherOS</li>        <li><a target="_blank" href="https://docs.docker.com/engine/admin">https://docs.docker.com/engine/admin</a> for more information on configuring Docker Engine on various distributions</li>   </ul>      <p>Once the registry is added; we can push our registry tagged image from where other nodes can download and consume it when required</p>      <p><img title="registry-insecure-registry" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-insecure-registry" src="/images/ee4bc29833cd_ABDC/registry-insecure-registry.png" border="0" height="492" width="821"></p>      <p>All we need to do now is update our v3 Compose File for the Docker Stack Deploy to use the our-registry/mvcapp image instead of just mvcapp so that all nodes can get it from “our-registry” address</p>   <script src="//gist-it.appspot.com/github/khurram-aziz/HelloDocker/blob/master/Redis/redis-v3.yml"></script>    <ul>     <li>Notice mvcapp image is changed accordingly </li>        <li>Notice the newly added Healthcheck section; it done so that if Redis Container is not available; the MVC app will break; this can happen if the node running the Redis container is not available; the Swarm will reschedule the Redis Container soemwhere else; and due to this healthceck; the MVC containers will also get rescheduled picking new Redis IP. This was done because the MVC app is talking to Redis using the IP and not the host name; details are in <a title="Redis Clients -- ASP.NET Core" target="_blank" href="redis-clients-asp-net-core.html">Redis Clients -- ASP.NET Core</a> post. </li>   </ul>      <p>Lets redeploy the stack, and we will have our mvcapp containers running on all the participating nodes; each node downloading the required image from the Registry automatically</p>      <p><img title="registry-stack-mvcapp" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-stack-mvcapp" src="/images/ee4bc29833cd_ABDC/registry-stack-mvcapp.png" border="0" height="552" width="1073"></p>      <p>Now to try a failure recovery; lets turn off the swarm3 node; and Docker Swarm should be able to recover automatically</p>      <p><img title="registry-swarm3-failure" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="registry-swarm3-failure" src="/images/ee4bc29833cd_ABDC/registry-swarm3-failure.png" border="0" height="507" width="1018"></p>      <p>Check <a title="https://docs.docker.com/registry/recipes" target="_blank" href="https://docs.docker.com/registry/recipes">https://docs.docker.com/registry/recipes</a> for other use cases of Docker Registry</p>      <p>If we are using Docker for Windows; we can add our insecure Registry into its Daemon; and once added; can make a docker container tagging directly for the registry and push it from the development machine/environment from where it can be used/picked by Swarm Nodes accordingly; giving us seamless deployment to cluster experience! </p>      <p><img title="registry-docker-for-windows" style="border-top:0px;border-right:0px;background-image:none;border-bottom:0px;padding-top:0px;padding-left:0px;border-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;" alt="registry-docker-for-windows" src="/images/ee4bc29833cd_ABDC/registry-docker-for-windows.png" border="0" height="760" width="961"></p>


        

      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="copyright">Copyright &#xA9; 2024</p>

        <ul class="list-inline text-center small">
            <li class="list-inline-item">
              <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
            </li>
            <li class="list-inline-item">
              <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
            </li>
        </ul>
        <br />
        <div class="font-weight-bold small"><a href="https://statiq.dev">Generated by Statiq</a></div>
      </div>
    </div>
  </div>
</footer>


  <!-- Scripts -->
  <script src='/vendor/bootstrap/js/bootstrap.bundle.min.js'></script>
  <script src='/vendor/startbootstrap-clean-blog/js/scripts.js'></script>
  <script src='/js/clean-blog.js'></script>
  

  

</body>

</html>
