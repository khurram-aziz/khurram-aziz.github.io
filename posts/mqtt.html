<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Khurram Aziz - MQ Telemetry Transport</title>

  <link rel="canonical" href='/posts/mqtt'>

      <link type="application/rss+xml" rel="alternate" title="Khurram Aziz" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" title="Khurram Aziz" href="/feed.atom" />

  <meta name="application-name" content='Khurram Aziz' />
  <meta name="msapplication-tooltip" content='Khurram Aziz' />
  <meta name="msapplication-starturl" content='/' />

  <meta property="og:title" content='Khurram Aziz - MQ Telemetry Transport' />
  <meta property="og:type" content="website" />
  <meta property="og:url" content='/posts/mqtt' />

  <link rel="icon" href='/favicon.ico'>

  <!-- Custom fonts for this template -->
  <link href='/vendor/fontawesome-free/css/all.min.css' rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" data-no-mirror>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" data-no-mirror>

  <!-- Styles for this template (also includes Bootstrap) -->
  <link href='/scss/clean-blog.css' rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js" data-no-mirror></script>
  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.3.0/dist/quicklink.umd.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.css" rel="stylesheet">

  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href='/'>Khurram Aziz</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ms-auto">
          <li class="nav-item">
    <a class="nav-link" href="/pages/about">About</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/pages/series">Series</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/posts">Posts</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="/tags">Tags</a>
  </li>

      </ul>
    </div>
  </div>
</nav>


  <!-- Page Header -->
  <header class="masthead no-image">
  <div class="container position-relative">
    <div class="row">
      <div class="col-md-12">
        <div class='post-heading'>
          <h1>
            MQ Telemetry Transport
          </h1>
            <div class="meta">Published on Monday, January 30, 2017</div>
              <div class="mt-3">
                  <a href="/tags/arduino" class="badge text-bg-light"> Arduino</a>
                  <a href="/tags/esp8266" class="badge text-bg-light"> ESP8266</a>
                  <a href="/tags/iot" class="badge text-bg-light"> IoT</a>
                  <a href="/tags/linux" class="badge text-bg-light"> Linux</a>
                  <a href="/tags/python" class="badge text-bg-light"> Python</a>
                  <a href="/tags/raspberry-pi" class="badge text-bg-light"> Raspberry Pi</a>
                  <a href="/tags/windows" class="badge text-bg-light"> Windows</a>
              </div>
        </div>
      </div>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="container">
    <div class="row">
      <div id="content" class="col-md-12">
        <p><b>ESP8266 Series</b></p>
<ul>
  <li><a title="Blink" href="/posts/blink.html">Blink</a></li>
  <li><a title="Arduino core for ESP8266 WiFi chip" href="/posts/arduino-core-esp8266.html">Arduino core for ESP8266 WiFi chip</a></li>
  <li><a title="Sonoff Dissection" href="/posts/sonoff-dissection.html">Sonoff Dissection</a></li>
  <li><a title="MQ Telemetry Transport" href="/posts/mqtt.html">MQ Telemetry Transport</a></li>
  <li><a title="Firmata" href="/posts/firmata.html">Firmata</a></li>
  <li><a title="Johnny-Five" href="/posts/johnny-five.html">Johnny-Five</a></li>
</ul>
<p>As soon as we have more than one IoT “thing” to manage; we need some kind of management; it quickly becomes cumbersome to use and manage the “smart devices”. We can use Shields like Ethernet, Wifi or GSM with Arduino or use ESP8266 with Arduino or on its own for connectivity, but we need some kind of server where all these devices connect to and from where we can control them. Secondly; even though these MCUs have descent processing power but for the user friendly solution often we need more and&nbsp;integration&nbsp;with the cloud or some proper PC / Single Board Computer is required.&nbsp;Say we deploy ESP8266 based Sonoff Smart&nbsp;switches for outdoor lights and want a “recipe” that when sun goes down the lights are turned on and when sun rises lights are turned off. For this we not only need&nbsp;the knowledge of sunsets and sunrises but we also need to&nbsp;coordinate&nbsp;the Sonoff “smart devices”. This is where protocols like MQTT comes in. As per wikipedia</p>      <p>MQTT (MQ Telemetry Transport) is an ISO standard publish-subscribe-based "lightweight" messaging protocol for use on top of the TCP/IP protocol. It is designed for connections with remote locations where a "small code footprint" is required or the network bandwidth is limited. The publish-subscribe messaging pattern requires a message broker. The broker is responsible for distributing messages to interested clients based on the topic of a message.</p>      <p>There exists PubSubClient library that we can use in Arduino IDE; the library works perfectly fine with Arduino Core for ESP8266. For the context you might want to check out my previous blog posts</p>  <ul>  <li><a href="/posts/sonoff-dissection.html" target="_blank">Sonoff Dissection</a></li>  <li><a href="/posts/arduino-core-ESP8266.html" target="_blank">Arduino core for ESP8266 WiFi chip</a></li>  </ul>  <p><img width="1352" height="594" title="mqtt-pubsubclient" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="mqtt-pubsubclient" src="/images/6b4aa71b3b65_C7F1/mqtt-pubsubclient.jpg" border="0"></p>      <p>We need MQTT Server; called MQTT Broker some where with known and static address. This can be in the cloud; either commercial or free; or we can deploy our own broker within the network. <a href="https://mosquitto.org/" target="_blank">Mosquitto</a> is popular open source MQTT broker that we can install either on Linux or on Windows. Installing on Linux is straight forward; we can even install and configure it on Raspbian (Raspberry Pi), but setting it up on Windows is little tricky. You need to install few other softwares and copy over the DLLs from there to Mosquitto’s installlation folder. Its all documented in its Setup Wizard; but if you need the step by step instructions; visit <a title="https://sivatechworld.wordpress.com/2015/06/11/step-by-step-installing-and-configuring-mosquitto-with-windows-7/" href="https://sivatechworld.wordpress.com/2015/06/11/step-by-step-installing-and-configuring-mosquitto-with-windows-7/" target="_blank">https://sivatechworld.wordpress.com/2015/06/11/step-by-step-installing-and-configuring-mosquitto-with-windows-7/</a></p>      <p>Its always a good idea to use authentication with network servers; use mosquitto_passwd utility that comes with it to create a password file and add the required users.</p>      <p><img width="640" height="287" title="nqtt-mosquitto-password" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="nqtt-mosquitto-password" src="/images/6b4aa71b3b65_C7F1/nqtt-mosquitto-password.jpg" border="0"></p>      <ul>     <li>Given I am creating the password file in Program Files; I needed Administrative Command Prompt </li>   </ul>      <p>Once the password file is in place; edit its conf file disabling anonymous users and setting path of the password file</p>      <p><img width="721" height="692" title="mqtt-mosquitto" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="mqtt-mosquitto" src="/images/6b4aa71b3b65_C7F1/mqtt-mosquitto.jpg" border="0"></p>      <ul>     <li>Given the conf file is in Program Files; you will need to open file in some editor that's running Administratively </li>   </ul>      <p>We can use MQTTLens; a Chrome application; to test Mosquitto; our MQTT Broker<img width="1232" height="734" title="mqtt-mqttlens" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="mqtt-mqttlens" src="/images/6b4aa71b3b65_C7F1/mqtt-mqttlens.jpg" border="0"></p>      <p>Once the broker is properly in place; we need to write a firmware for our appliance; that connects to MQTT broker; publish its status / logs there and gets the command from it by subscribing to related topics. The PubSubClient library comes with many examples including mqtt_auth that we can use to write the firmware for Arduino or ESP8266 MCUs</p>      <p><img width="690" height="578" title="mqtt-pubsubclient-examples" style="border-left-width:0px;border-right-width:0px;background-image:none;border-bottom-width:0px;padding-top:0px;padding-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;border-top-width:0px;" alt="mqtt-pubsubclient-examples" src="/images/6b4aa71b3b65_C7F1/mqtt-pubsubclient-examples.jpg" border="0"></p>      <p>Here’s the Arduino IDE code for one such firmware that I wrote for my NodeMCU development board; it takes the command from the MQTT and turn the LED on or off accordingly. </p>   <script src="http://gist-it.appspot.com/github/khurram-aziz/HelloArduino/blob/master/nodemcu-mqtt.ino"></script>    <p>Once we have the firmware developed and tested; we can easily use it in real world IoT appliances like <a title="Sonoff Dissection" href="/posts/sonoff-dissection.html" target="_blank">Sonoff</a>. Now that our smart appliance is connected to the MQTT; we can control it from elsewhere on demand. We can have a program / scheduled job / trigger; configured in a cloud or running on a PC or Raspberry Pi that at the time of Sunset and Sunrise send appropriate messages to the MQTT broker and the smart appliance with oblige accordingly. <a href="https://eclipse.org/paho/clients/python/" target="_blank">Eclipse’ Paho</a> project provides open source client implementations of MQTT; <a title="https://eclipse.org/paho/clients/python/" href="https://eclipse.org/paho/clients/python/" target="_blank">https://eclipse.org/paho/clients/python/</a> is one such Python client library that’s just “pip install paho-mqtt” away. Here’s one such python script that flashes the LED connected to NodeMCU by sending required payloads to the appropriate topic where NodeMCU is subscribed to</p>      <p><img width="1086" height="479" title="mqtt-python" style="border-top:0px;border-right:0px;background-image:none;border-bottom:0px;padding-top:0px;padding-left:0px;border-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;" alt="mqtt-python" src="/images/6b4aa71b3b65_C7F1/mqtt-python.jpg" border="0"></p>      <p>On receiving the messages; the NodeMCU flashes the LED accordingly; here’s what my firmware is writing to Serial port </p>      <p><img width="919" height="504" title="mqtt-esp8266" style="border-top:0px;border-right:0px;background-image:none;border-bottom:0px;padding-top:0px;padding-left:0px;border-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;" alt="mqtt-esp8266" src="/images/6b4aa71b3b65_C7F1/mqtt-esp8266.jpg" border="0"></p>            <p>With MQTT understanding and how it can be used to orchestrate the IoT appliances; the architecture of our Sunset/Sunrise Automatic Outdoor Lights solution would be something like this</p>      <p><img width="931" height="400" title="mqtt-iot-solution" style="border-top:0px;border-right:0px;background-image:none;border-bottom:0px;padding-top:0px;padding-left:0px;border-left:0px;margin:10px 10px 0px 0px;display:inline;padding-right:0px;" alt="mqtt-iot-solution" src="/images/6b4aa71b3b65_C7F1/mqtt-iot-solution.jpg" border="0"></p>      <p>We can either user some Cloud API for sunset/sunrise times; or store the times in some local database; given Raspbian on Raspberry Pi gives us a very rich Linux experience; we can deploy mySQL and Mosquito on it along with our custom program in Python (or any other language / platform of our choice)</p>


        

      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->
  <footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12 text-center">
        <p class="copyright">Copyright &#xA9; 2024</p>

        <ul class="list-inline text-center small">
            <li class="list-inline-item">
              <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
            </li>
            <li class="list-inline-item">
              <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
            </li>
        </ul>
        <br />
        <div class="font-weight-bold small"><a href="https://statiq.dev">Generated by Statiq</a></div>
      </div>
    </div>
  </div>
</footer>


  <!-- Scripts -->
  <script src='/vendor/bootstrap/js/bootstrap.bundle.min.js'></script>
  <script src='/vendor/startbootstrap-clean-blog/js/scripts.js'></script>
  <script src='/js/clean-blog.js'></script>
  

  

</body>

</html>
